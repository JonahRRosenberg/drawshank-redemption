<!doctype html>
<html>
    <head>
        <title>Drawing</title>

        <link rel="stylesheet" href="style.css">

        <script src="https://cdn.firebase.com/js/client/2.2.9/firebase.js"></script>
        <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>

        <script src="update-connectivity.js"></script>

        <script>
            var myFirebaseRef = new Firebase("https://burning-torch-3848.firebaseio.com/");

        </script>

        <meta name="viewport" content="initial-scale=1.0">

    </head>

    <body>

        <img id="connected"></img>

        <a href="switching.html"><img id="goSwitchImage" src="resources/go-switch.jpg"></img></a>

        <div class="l-demo-container">
            <canvas id="drawing-canvas" width="480" height="420"></canvas>
        </div>
        <div id="colorholder"></div>

        <script>
            $(document).ready(function () {
                //Set up some globals
                var currentColor = "000";
                var mouseDown = 0;
                var curPoints = []

                //Create a reference to the pixel data for our drawing.
                var pixelDataRef = new Firebase('https://burning-torch-3848.firebaseio.com/pixel-data');

                // Set up our canvas
                var myCanvas = document.getElementById('drawing-canvas');
                var myContext = myCanvas.getContext ? myCanvas.getContext('2d') : null;
                if (myContext == null) {
                    alert("You must use a browser that supports HTML5 Canvas to run this demo.");
                    return;
                }

                //Setup each color palette & add it to the screen
                var colors = ["fff","000","f00","0f0","00f","88f","f8d","f88","f05","f80","0f8","cf0","08f","408","ff8","8ff"];
                for (c in colors) {
                    var item = $('<div/>').css("background-color", '#' + colors[c]).addClass("colorbox");
                    item.click((function () {
                        var col = colors[c];
                        return function () {
                            currentColor = col;
                        };
                    })());
                    item.appendTo('#colorholder');
                }

                //Keep track of if the mouse is up or down
                myCanvas.onmousedown = function () {mouseDown = 1;};
                myCanvas.onmouseout = myCanvas.onmouseup = function () {
                    mouseDown = 0;
                    curPoints = [];
                };

                //Draw a line from the mouse's last position to its current position
                var drawLineOnMouseMove = function(e) {
                    if (!mouseDown) return;

                    e.preventDefault();

                    var offset = $('canvas').offset();
                    var curX = e.pageX - offset.left;
                    var curY = e.pageY - offset.top;

                    if (curPoints.length === 0) {
                        curPoints.push([curX, curY]);
                    }

                    var lastPoint = curPoints[curPoints.length-1];
                    var lastX = lastPoint[0];
                    var lastY = lastPoint[1];

                    //Moved - method
                    if (lastX !== curX || lastY !== curY) {
                        curPoints.push([curX, curY])

                        if (curPoints.length === 4) {
                            myContext.beginPath();
                            // myContext.moveTo(188, 130);
                            // myContext.bezierCurveTo(140, 10, 388, 10, 388, 170);
                            myContext.moveTo(curPoints[0][0], curPoints[0][1]);
                            myContext.bezierCurveTo(
                                curPoints[1][0], curPoints[1][1],
                                curPoints[2][0], curPoints[2][1],
                                curPoints[3][0], curPoints[3][1]);
                            myContext.lineWidth = 3;

                            myContext.strokeStyle = "#" + currentColor;
                            myContext.stroke();

                            curPoints = [curPoints[3]];
                        }
                    }
                    // pixelDataRef.child(curX + ":" + curY).set(currentColor === "fff" ? null : currentColor);
                };

                $(myCanvas).mousemove(drawLineOnMouseMove);
                $(myCanvas).mousedown(drawLineOnMouseMove);

                // Add callbacks that are fired any time the pixel data changes and adjusts the canvas appropriately.
                // Note that child_added events will be fired for initial pixel data as well.
                var drawPixel = function(snapshot) {
                    var coords = snapshot.key().split(":");
                    myContext.fillStyle = "#" + snapshot.val();
                    myContext.fillRect(parseInt(coords[0]) * pixSize, parseInt(coords[1]) * pixSize, pixSize, pixSize);
                };
                var clearPixel = function(snapshot) {
                    var coords = snapshot.key().split(":");
                    myContext.clearRect(parseInt(coords[0]) * pixSize, parseInt(coords[1]) * pixSize, pixSize, pixSize);
                };
                // pixelDataRef.on('child_added', drawPixel);
                // pixelDataRef.on('child_changed', drawPixel);
                // pixelDataRef.on('child_removed', clearPixel);
            });
        </script>

    </body>
</html>
